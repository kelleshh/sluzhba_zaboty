# Служба Заботы — Telegram-бот поддержки BOUQ

Телеграм-бот для поддержки пользователей бренда BOUQ.  
Бот принимает обращения (гарантия / возврат / другой вопрос), создает тикеты, уведомляет операторов и позволяет оператору вести живой диалог с пользователем через бота.  
История переписки сохраняется в базе.

---

## Навигация

- [1. Возможности бота](#1-возможности-бота)
- [2. Пользовательские сценарии (кратко)](#2-пользовательские-сценарии-кратко)
  - [2.1 Обращение по гарантии](#21-обращение-по-гарантии)
  - [2.2 Возврат товара](#22-возврат-товара)
  - [2.3 Другой вопрос](#23-другой-вопрос)
  - [2.4 Работа оператора](#24-работа-оператора)
- [3. Хранение истории](#3-хранение-истории)
- [4. Архитектура проекта](#4-архитектура-проекта)
- [5. Подготовка окружения](#5-подготовка-окружения)
- [6. Запуск через Docker](#6-запуск-через-docker)
- [7. Проверка работы](#7-проверка-работы)
  - [7.1 Логи бота](#71-логи-бота)
  - [7.2 Подключение к базе](#72-подключение-к-базе)
  - [7.3 Просмотр тикетов и сообщений](#73-просмотр-тикетов-и-сообщений)
- [8. Важные детали эксплуатации](#8-важные-детали-эксплуатации)

---

## 1. Возможности бота

- Главное меню в боте с тремя сценариями:
  - обращение по гарантии,
  - возврат товара,
  - другой вопрос.
- Сбор текста и вложений от пользователя (описание проблемы, чек, фото/видео).
- Создание тикета в базе и уведомление операторов в общем операторском чате.
- Кнопка «Взять в работу» для операторов.
- Перевод тикета в живой диалог «оператор ↔ пользователь» прямо через бота.
- Кнопка «Завершить диалог» для оператора.
- История переписки (обе стороны) сохраняется в Postgres.

---

## 2. Пользовательские сценарии (кратко)

### 2.1 Обращение по гарантии
1. Бот просит описать проблему и где был куплен товар.
2. Бот просит вложения (чек / скрин заказа / фото или видео проблемы).
3. После получения данных создается тикет со статусом `WAITING`.
4. В операторский чат уходит карточка тикета с кнопкой «Взять в работу» и с контентом пользователя.
5. Пользователь получает подтверждение и кнопку «В начало».

Цель: сформировать гарантийное обращение с материалами (фото/видео/чек), чтобы оператор сразу видел суть.

### 2.2 Возврат товара
1. Бот объясняет правила возврата:
   - «нормальный» возврат товара надлежащего качества делается через маркетплейс (Ozon / WB и т. д.);
   - если проблема в качестве (брак, течет и т. п.) — это гарантия.
2. Бот предлагает:
   - перейти в «Обращение по гарантии»;
   - или перейти в «Другой вопрос».

Тикет на этом шаге сам по себе не создается: пользователь решает, куда идти дальше.

### 2.3 Другой вопрос
1. Бот просит описать вопрос (комплектующая, характеристики, доп. аксессуары и т. д.).
2. Пользователь жмет «Отправить сообщение сотруднику».
3. Бот просит прислать сообщение с вопросом.
4. Создается тикет со статусом `WAITING`, операторский чат получает карточку с кнопкой «Взять в работу».
5. Пользователь получает подтверждение и кнопку «В начало».

### 2.4 Работа оператора
1. В операторском групповом чате бот публикует новые тикеты с кнопкой «Взять в работу».
2. Первый оператор, кто нажмет «Взять в работу»:
   - закрепляет тикет за собой (статус `ASSIGNED`);
   - получает от бота личное сообщение с инструкцией и кнопкой «Завершить диалог»;
   - пользователь получает уведомление, что оператор подключился.
3. Дальше идет живой диалог:
   - все, что пишет пользователь боту, бот пересылает оператору;
   - все, что пишет оператор боту, бот пересылает пользователю.
4. Оператор может нажать «Завершить диалог»:
   - тикет получает статус `CLOSED`;
   - пользователю отправляется сообщение «Оператор отключился» + кнопка «В начало».

---

## 3. Хранение истории

Бот пишет в базу:
- сообщения пользователя при создании обращения (текст и вложения),
- сообщения пользователя и оператора во время живого диалога после того, как тикет взят в работу.

Не пишутся:
- нажатия на кнопки («возврат товара», «отправить сообщение сотруднику» и т. д.),
- служебные уведомления бота в операторский групповой чат.

Таблица `ticket_messages` хранит:
- `ticket_id`,
- `sender_type` (`user` или `operator`),
- `content_type` (text, photo, video, ...),
- текст сообщения / подпись к медиа,
- временную метку.

Это дает аудит обращений (кто что сказал и когда) и историю переписки минимум за полгода.

---

## 4. Архитектура проекта

```text
.
├── docker-compose.yml
├── Dockerfile
├── requirements.txt
├── .env.example
├── src
│   ├── app.py                  # точка входа бота
│   ├── config.py               # настройки через pydantic-settings (чтение .env)
│   ├── texts.py                # пользовательские тексты/сообщения
│   ├── routers/
│   │   ├── public.py           # главное меню, сценарии гарантия / возврат / другой вопрос, FSM
│   │   ├── operators.py        # «взять в работу», «завершить диалог»
│   │   └── proxy.py            # проксирование живого чата оператор ↔ пользователь
│   ├── keyboards/
│   │   ├── main.py             # инлайн-кнопки для пользователя
│   │   └── operator.py         # инлайн-кнопки для оператора
│   ├── db/
│   │   ├── base.py             # движок SQLAlchemy, SessionLocal, init_db()
│   │   ├── models.py           # User, Ticket, TicketMessage
│   │   └── bootstrap.py        # добавление недостающих колонок при старте
│   └── utils/
│       ├── logging.py          # настройка логирования
│       └── files.py            # работа с медиа
├── media/                      # локальное хранилище вложений
└── legacy/
        ├── phone.py            # нормализация номера телефона (опционально)
```

Главное для нас сейчас:
- FSM состояния для диалогов с пользователем живут внутри `public.py`.
- Логика удаления старых клавиатур после нажатия (чтобы не было повторных кликов) тоже в `public.py`.
- `operators.py` отвечает за закрепление тикета за оператором и закрытие диалога.
- `proxy.py` отвечает за пересылку реплик между пользователем и оператором и за логирование этих сообщений в базу.

---

## 5. Подготовка окружения

1. Создать `.env` на основе `.env.example`:

```env
# Telegram
BOT_TOKEN=123456:ABCDEF...          # токен бота
OPERATORS_CHAT_ID=-1001234567890    # ID группового чата операторов

# Postgres
POSTGRES_HOST=db
POSTGRES_PORT=5432
POSTGRES_DB=care
POSTGRES_USER=admin
POSTGRES_PASSWORD=adminpass

# Прочее
DEFAULT_REGION=RU
MEDIA_ROOT=media
STORE_MEDIA_LOCAL=true # обязательно для логирования медиа
```

Важные пояснения:
- `OPERATORS_CHAT_ID` — это id группового чата операторов, куда бот шлет новые заявки и кнопку «Взять в работу».
- Бота нужно заранее добавить в этот чат.
- Каждый оператор должен один раз написать боту `/start` в личные сообщения, чтобы бот потом мог отвечать ему в личку.
- База Postgres хранится в докер-томе (volume), так что данные не пропадают между перезапусками.

---

## 6. Запуск через Docker

Собрать и поднять все:
```bash
docker compose up -d --build
```

Это поднимет два контейнера:
- `db` (Postgres),
- `bot` (сам бот).

Проверить статус контейнеров:
```bash
docker compose ps
```

---

## 7. Проверка работы

### 7.1 Логи бота
```bash
docker compose logs -f bot
```

Ожидаемая картина:
- бот пишет что-то вроде `Start polling`
- без traceback.

### 7.2 Подключение к базе
Открыть psql в рантайме:
```bash
docker compose exec db psql -U admin -d care
```

Посмотреть список таблиц:
```sql
\dt
```

Должны быть `users`, `tickets`, `ticket_messages`.

### 7.3 Просмотр тикетов и сообщений

Последние тикеты:
```bash
docker compose exec db psql -U admin -d care -c "SELECT id,status,operator_tg_id,created_at,closed_at
 FROM tickets
 ORDER BY id DESC
 LIMIT 10;"
```

Последние сообщения (живой диалог и обращения):
```bash
docker compose exec db psql -U admin -d care -c "SELECT ticket_id,sender_type,content_type,message_text,caption,created_at
 FROM ticket_messages
 ORDER BY id DESC
 LIMIT 20;"
```

Резервная копия базы:
```bash
docker compose exec -T db pg_dump -U admin care > backup_$(date +%F_%H%M).sql
```

---

## 8. Важные детали эксплуатации

- Когда создается тикет, он получает статус `WAITING`.  
  В операторский чат падает карточка тикета + кнопка «Взять в работу».

- Когда оператор жмет «Взять в работу»:
  - тикет помечается `ASSIGNED`,
  - оператор получает в личку чат с пользователем и кнопку «Завершить диалог»,
  - пользователь получает «Оператор подключился».

- Переписка после назначения оператора проксируется ботом и сохраняется в базу.

- Когда оператор завершает диалог:
  - тикет помечается `CLOSED`,
  - пользователю отправляется «Оператор отключился» и кнопка «В начало».

- Не логируются клики по кнопкам.  
  Логируются реальные сообщения (пользователя и оператора), чтобы можно было поднять историю общения позже.

---

© BOUQ Служба Заботы