# Служба Заботы — Telegram-бот операторской поддержки

Бот для маршрутизации обращений пользователей: стартовое меню с темами, сбор телефона, постановка в очередь, уведомление операторов в общем чате, «бронь» диалога первым оператором, проксирование живой переписки «оператор ↔ пользователь», корректное завершение диалога. История сообщений хранится в PostgreSQL не менее 6 месяцев.

---

## Содержание

- [Возможности](#возможности)
- [Технологии](#технологии)
- [Архитектура и поток событий](#архитектура-и-поток-событий)
- [Структура репозитория](#структура-репозитория)
- [Быстрый старт (Docker)](#быстрый-старт-docker)
- [Переменные окружения](#переменные-окружения)
- [Как получить OPERATORS_CHAT_ID](#как-получить-operators_chat_id)
- [Локальный запуск без Docker](#локальный-запуск-без-docker)
- [Операции и обслуживание](#операции-и-обслуживание)
- [Хранение истории и медиа](#хранение-истории-и-медиа)
- [Индексы и защита от гонок](#индексы-и-защита-от-гонок)
- [Требования и версии](#требования-и-версии)
- [Точки расширения](#точки-расширения)
- [Лицензия](#лицензия)

---

## Возможности

- Стартовое окно с кнопками: **Гарантия**, **Возврат**, **Другой вопрос**.
- Для «Гарантия/Возврат» показываются шаблонные ответы + кнопки: **Понятно**, **Обратиться к оператору**.
- Для «Другой вопрос»: уточнение «Связаться с оператором?» с кнопками **Да/Нет**.
- Сбор номера телефона с валидацией и сохранением в БД.
- Уведомление в **операторский групповой чат**: карточка с данными пользователя и кнопкой **Взять в работу**.
- Закрепление диалога за **первым нажавшим** оператором, пользователю приходит «Оператор подключился».
- Прокси-переписка: все сообщения в ЛС оператора пересылаются пользователю и наоборот.
- Завершение диалога оператором: пользователю приходит «Оператор отключился» и кнопка **В начало**.
- Хранение истории: пользователи, тикеты, сообщения; опционально метаданные медиа и локальное сохранение файлов.

---

## Технологии

- **Python 3.11**
- **aiogram 3.x**
- **PostgreSQL 16**
- **SQLAlchemy 2.x**
- **pydantic-settings 2.x**
- **phonenumbers**
- **Docker / Docker Compose**

---

## Архитектура и поток событий

1. Пользователь выбирает тему в стартовом меню.
2. При выборе «Обратиться к оператору» вводит телефон. Бот валидирует и сохраняет.
3. В **операторский чат** падает карточка с кнопкой «Взять в работу».
4. Первый оператор, кто нажал, **закрепляет** тикет. Пользователь видит «Оператор подключился».
5. Оператор пишет боту в ЛС — бот пересылает сообщение пользователю; сообщения пользователя пересылаются оператору.
6. Оператор жмет «Завершить диалог» — пользователю приходит «Оператор отключился» + **В начало**.

---

## Структура репозитория

```
.
├── docker-compose.yml
├── Dockerfile
├── requirements.txt
├── .env.example
├── src
│   ├── app.py                  # точка входа
│   ├── texts.py                # тексты сообщений
│   ├── config.py               # настройки (pydantic-settings)
│   ├── routers/
│   │   ├── public.py           # меню, сбор телефона, уведомление операторов
│   │   ├── operators.py        # «взять в работу», завершение диалога
│   │   └── proxy.py            # прокси переписки оператор ↔ пользователь
│   ├── keyboards/
│   │   ├── main.py             # стартовые/тематические кнопки
│   │   └── operator.py         # «Взять в работу», «Завершить диалог»
│   ├── db/
│   │   ├── base.py             # engine, SessionLocal, init_db()
│   │   ├── models.py           # User, Ticket, TicketMessage (+ опц. MessageAttachment)
│   │   └── bootstrap.py        # идемпотентные индексы/доп. таблицы при старте
│   ├── services/
│   │   ├── phone.py            # normalize_phone()
│   │   └── files.py            # (опц.) скачивание медиа в ./media
│   └   └── logging.py          # базовая настройка логов
└── media/                      # (опц.) локальное хранение медиа (volume)
```

---

## Быстрый старт (Docker)

1. Установите Docker и compose-plugin.

2. Скопируйте `.env.example` в `.env` и заполните значения (см. раздел ниже).

3. Добавьте бота в **операторскую группу** и получите `OPERATORS_CHAT_ID`.

4. Запустите:
   ```bash
   docker compose up -d --build
   ```

5. Убедитесь, что сервисы работают:
   ```bash
   docker compose logs -f bot
   docker compose logs -f db
   docker compose exec db psql -U admin -d care -c '\dt'
   ```

6. Важно: каждый оператор должен один раз написать боту в ЛС `/start`, иначе бот не сможет отправлять ему сообщения.

> Примечание: если в логах Docker Compose видите предупреждение про `version:` — удалите строку `version: ...` из `docker-compose.yml`. Это косметика.

---

## Переменные окружения

Создайте `.env` в корне проекта (можно на основе `.env.example`):

```env
# Telegram
BOT_TOKEN=123456:ABCDEF...          # токен бота
OPERATORS_CHAT_ID=-666666666   # id группового чата операторов (для супергрупп — отрицательный -100...)

# Postgres
POSTGRES_HOST=db
POSTGRES_PORT=5432
POSTGRES_DB=care
POSTGRES_USER=your_login
POSTGRES_PASSWORD=your_ultra_secret_password

# Телефоны
DEFAULT_REGION=RU                   # регион для парсинга телефонов (phonenumbers)

# Медиа (опционально)
MEDIA_ROOT=media
STORE_MEDIA_LOCAL=true              # true — скачивать медиа локально в ./media
```

> Контейнер БД учитывает `POSTGRES_*` только при **первой** инициализации тома. Если том уже создан, значения пользователя/пароля/БД берутся из существующего кластера.

---

## Как получить `OPERATORS_CHAT_ID`

1. Создайте в Telegram групповой чат операторов и **добавьте туда бота**.
2. Напишите в чат любое сообщение.
3. Выполните:
   ```bash
   curl -s "https://api.telegram.org/bot$BOT_TOKEN/getUpdates"
   ```
   В ответе найдите `message.chat.id`. Для супергруппы это отрицательное число вида `-......`.

---

## Локальный запуск без Docker

> Для локальной отладки. Для продакшена используйте Docker.

```bash
python -V              # нужен 3.11+
python -m venv .venv && source .venv/bin/activate
pip install -r requirements.txt
# подхватить переменные окружения
export $(grep -v '^#' .env | xargs)
python -m src.app
```

PostgreSQL должен быть доступен (локально или в контейнере). Таблицы создаются через `init_db()` автоматически.

---

## Операции и обслуживание

Логи:
```bash
docker compose logs -f bot
docker compose logs -f db
```

Консоль БД:
```bash
docker compose exec db psql -U admin -d care
```

Бэкап БД (SQL-дамп на хост):
```bash
docker compose exec -T db pg_dump -U admin care > backup_$(date +%F_%H%M).sql
```

Полезные запросы:
```bash
docker compose exec db psql -U admin -d care -c \
"SELECT id,status,operator_tg_id,created_at,closed_at FROM tickets ORDER BY id DESC LIMIT 10;"

docker compose exec db psql -U admin -d care -c \
"SELECT ticket_id,sender_type,content_type,created_at FROM ticket_messages ORDER BY id DESC LIMIT 20;"
```

---

## Хранение истории и медиа

- Таблица `ticket_messages`:
  - `message_text` для текстовых сообщений;
  - `caption` для подписи к медиа;
  - `content_type` (text/photo/document/video/voice/…);
  - базовые метаданные и время.

- (Опционально) Таблица `message_attachments`:
  - метаданные файлов (`file_id`, `file_unique_id`, `mime_type`, `size`, `width/height`, `duration`, `file_name`);
  - `local_path`, если включено локальное скачивание в `MEDIA_ROOT`.

- Локальное сохранение медиа:
  - включается `STORE_MEDIA_LOCAL=true`;
  - каталог управляется `MEDIA_ROOT` (по умолчанию `./media`, примонтирован в контейнере);
  - скачивание реализовано в `src/services/files.py`.

> Рекомендация: бинарные файлы хранить на диске или в объектном хранилище (S3/MinIO). В БД держать только метаданные и путь/ключ.

---

## Индексы и защита от гонок

При старте приложения выполняется идемпотентный `bootstrap`:

- частичный уникальный индекс на `tickets(operator_tg_id)` при `status='ASSIGNED'`, чтобы один оператор не держал более одного активного диалога;
- индекс на историю сообщений `(ticket_id, created_at)`.

При «брони» тикета используется атомарное обновление `UPDATE ... WHERE status='WAITING'` с проверкой `rowcount`, чтобы исключить гонки «двое нажали одновременно».

---

## Требования и версии

- Python 3.11
- aiogram 3.7+ (используется `DefaultBotProperties(parse_mode=HTML)`)
- PostgreSQL 16
- Все остальные зависимости перечислены в `requirements.txt`.

---

## Точки расширения

- Команда администратора со статистикой (активные тикеты, SLA, среднее время ответа/закрытия).
- Авто-закрытие по неактивности (фон-таск/cron).
- Перевод на webhook (при наличии домена/HTTPS).
- Роли и ACL для операторов.
- Миграции Alembic для версионирования схемы БД.

---

### Проверить:

- [ ] `.env` заполнен, `OPERATORS_CHAT_ID` верный (супергруппа: `-100…`).
- [ ] Бот добавлен в операторскую группу.
- [ ] Каждый оператор написал боту `/start` в личку.
- [ ] `docker compose up -d --build` завершился, в логах — `Start polling`.
- [ ] В БД есть таблицы `users`, `tickets`, `ticket_messages`,`message_attachments`.
- [ ] Карточка «Новый клиент #…» приходит в операторский чат; бронь работает; переписка проксируется; завершение диалога показывает «Оператор отключился» и кнопку **В начало**.